<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ìå®ÌÑ¥ Îß§ÎãàÏ†Ä - 080 ÏàòÏã†Í±∞Î∂Ä ÏûêÎèôÌôî</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            padding: 30px;
        }

        .pattern-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .pattern-table th,
        .pattern-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .pattern-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .pattern-table tr:hover {
            background: #f7fafc;
        }

        .pattern-table td {
            font-size: 0.95rem;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-secondary {
            background: #718096;
        }

        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(113, 128, 150, 0.4);
        }

        .btn-danger {
            background: #e53e3e;
        }

        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(229, 62, 62, 0.4);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .help-text {
            font-size: 0.9rem;
            color: #718096;
            margin-top: 5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9rem;
        }

        .alert {
            padding: 16px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            animation: fadeIn 0.3s ease;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 20px;
            transition: color 0.3s ease;
        }

        .back-link:hover {
            color: #764ba2;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-auto {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-verified {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-unverified {
            background: #fee2e2;
            color: #991b1b;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
            }
        }

        .new-pattern {
            animation: fadeIn 0.5s ease, pulse 2s ease-in-out;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .card-body {
                padding: 20px;
            }
            
            .pattern-table {
                font-size: 0.85rem;
            }
            
            .pattern-table th,
            .pattern-table td {
                padding: 8px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }

        .label {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            margin: 2px;
        }
        .auto-generated {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        .needs-verification {
            background-color: #fff3e0;
            color: #f57c00;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.php" class="back-link">
            ‚Üê Î©îÏù∏ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
        </a>

        <div class="header">
            <h1>üß† Ìå®ÌÑ¥ Îß§ÎãàÏ†Ä</h1>
            <p>080 Î≤àÌò∏Î≥Ñ DTMF Ìå®ÌÑ¥ÏùÑ Í¥ÄÎ¶¨ÌïòÍ≥† ÏµúÏ†ÅÌôîÌï©ÎãàÎã§</p>
        </div>

        <?php
        /**
         * 080Î≤àÌò∏ Ìå®ÌÑ¥ Í¥ÄÎ¶¨Ïûê
         * - Ìå®ÌÑ¥ Î°úÎìú/Ï†ÄÏû•
         * - Ìå®ÌÑ¥ Í≤ÄÏ¶ù Î∞è ÏóÖÎç∞Ïù¥Ìä∏
         * - Ìå®ÌÑ¥ ÌÜµÍ≥Ñ Î∞è Í¥ÄÎ¶¨
         */

        class PatternManager {
            private $patternsFile;
            
            public function __construct($patternsFile = null) {
                $this->patternsFile = $patternsFile ?? __DIR__ . '/patterns.json';
            }
            
            /**
             * Ìå®ÌÑ¥ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
             */
            public function getPatterns() {
                if (!file_exists($this->patternsFile)) {
                    return $this->getDefaultPatterns();
                }
                
                $data = json_decode(file_get_contents($this->patternsFile), true);
                if (!$data || !isset($data['patterns'])) {
                    return $this->getDefaultPatterns();
                }
                
                return $data;
            }
            
            /**
             * Í∏∞Î≥∏ Ìå®ÌÑ¥ Íµ¨Ï°∞ Î∞òÌôò
             */
            private function getDefaultPatterns() {
                return [
                    'patterns' => [
                        'default' => [
                            'name' => 'Í∏∞Î≥∏Í∞í',
                            'description' => 'ÏïåÎ†§ÏßÄÏßÄ ÏïäÏùÄ Î≤àÌò∏Ïö© Í∏∞Î≥∏ ÏÑ§Ï†ï',
                            'initial_wait' => 3,
                            'dtmf_timing' => 6,
                            'dtmf_pattern' => '{ID}#',
                            'confirmation_wait' => 2,
                            'confirmation_dtmf' => '1',
                            'total_duration' => 30,
                            'confirm_delay' => 2,
                            'confirm_repeat' => 3,
                            'notes' => 'ÏÉàÎ°úÏö¥ Î≤àÌò∏Îäî Ïù¥ Ìå®ÌÑ¥ÏúºÎ°ú ÏãúÏûë'
                        ]
                    ],
                    'variables' => [
                        '{ID}' => 'Í¥ëÍ≥† Î¨∏ÏûêÏóêÏÑú Ï∂îÏ∂úÌïú ÏãùÎ≥ÑÎ≤àÌò∏',
                        '{Phone}' => 'Ìú¥ÎåÄÌè∞ Î≤àÌò∏'
                    ]
                ];
            }
            
            /**
             * Ìå®ÌÑ¥ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
             */
            public function savePatterns($patterns) {
                try {
                    $json = json_encode($patterns, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
                    if ($json === false) {
                        throw new Exception('JSON Ïù∏ÏΩîÎî© Ïã§Ìå®');
                    }
                    
                    // Î∞±ÏóÖ ÏÉùÏÑ±
                    if (file_exists($this->patternsFile)) {
                        copy($this->patternsFile, $this->patternsFile . '.backup.' . date('YmdHis'));
                    }
                    
                    // ÏûÑÏãú ÌååÏùºÏóê Ïì∞Í≥† ÏõêÏûêÏ†Å Ïù¥Îèô
                    $tempFile = $this->patternsFile . '.tmp';
                    if (file_put_contents($tempFile, $json) === false) {
                        throw new Exception('ÏûÑÏãú ÌååÏùº Ïì∞Í∏∞ Ïã§Ìå®');
                    }
                    
                    if (!rename($tempFile, $this->patternsFile)) {
                        throw new Exception('ÌååÏùº Ïù¥Îèô Ïã§Ìå®');
                    }
                    
                    return true;
                    
                } catch (Exception $e) {
                    // ÏûÑÏãú ÌååÏùº Ï†ïÎ¶¨
                    if (isset($tempFile) && file_exists($tempFile)) {
                        unlink($tempFile);
                    }
                    throw $e;
                }
            }
            
            /**
             * ÌäπÏ†ï Î≤àÌò∏Ïùò Ìå®ÌÑ¥ Í∞ÄÏ†∏Ïò§Í∏∞
             */
            public function getPattern($phoneNumber) {
                $patterns = $this->getPatterns();
                return $patterns['patterns'][$phoneNumber] ?? $patterns['patterns']['default'] ?? null;
            }
            
            /**
             * Ìå®ÌÑ¥ Ï∂îÍ∞Ä ÎòêÎäî ÏóÖÎç∞Ïù¥Ìä∏
             */
            public function updatePattern($phoneNumber, $patternData) {
                $patterns = $this->getPatterns();
                
                // ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÍ∞Ñ Ï∂îÍ∞Ä
                $patternData['updated_at'] = date('Y-m-d H:i:s');
                
                // Í∏∞Ï°¥ Ìå®ÌÑ¥Ïù¥ ÏûàÏúºÎ©¥ ÏùºÎ∂Ä Ï†ïÎ≥¥ Î≥¥Ï°¥
                if (isset($patterns['patterns'][$phoneNumber])) {
                    $existing = $patterns['patterns'][$phoneNumber];
                    $patternData['created_at'] = $existing['created_at'] ?? date('Y-m-d H:i:s');
                    $patternData['usage_count'] = $existing['usage_count'] ?? 0;
                    $patternData['last_used'] = $existing['last_used'] ?? null;
                } else {
                    $patternData['created_at'] = date('Y-m-d H:i:s');
                    $patternData['usage_count'] = 0;
                }
                
                $patterns['patterns'][$phoneNumber] = $patternData;
                
                return $this->savePatterns($patterns);
            }
            
            /**
             * Ìå®ÌÑ¥ ÏÇ¨Ïö© Í∏∞Î°ù ÏóÖÎç∞Ïù¥Ìä∏
             */
            public function recordPatternUsage($phoneNumber, $success = null) {
                $patterns = $this->getPatterns();
                
                if (!isset($patterns['patterns'][$phoneNumber])) {
                    return false;
                }
                
                $pattern = &$patterns['patterns'][$phoneNumber];
                $pattern['usage_count'] = ($pattern['usage_count'] ?? 0) + 1;
                $pattern['last_used'] = date('Y-m-d H:i:s');
                
                if ($success !== null) {
                    if (!isset($pattern['success_stats'])) {
                        $pattern['success_stats'] = ['success' => 0, 'failed' => 0];
                    }
                    
                    if ($success) {
                        $pattern['success_stats']['success']++;
                        // ÏÑ±Í≥µÌïòÎ©¥ Í≤ÄÏ¶ù ÏôÑÎ£åÎ°ú ÌëúÏãú
                        if (isset($pattern['needs_verification'])) {
                            $pattern['needs_verification'] = false;
                            $pattern['verified_at'] = date('Y-m-d H:i:s');
                        }
                    } else {
                        $pattern['success_stats']['failed']++;
                    }
                }
                
                return $this->savePatterns($patterns);
            }
            
            /**
             * Ìå®ÌÑ¥ ÏÇ≠Ï†ú
             */
            public function deletePattern($phoneNumber) {
                if ($phoneNumber === 'default') {
                    throw new Exception('Í∏∞Î≥∏ Ìå®ÌÑ¥ÏùÄ ÏÇ≠Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§');
                }
                
                $patterns = $this->getPatterns();
                
                if (!isset($patterns['patterns'][$phoneNumber])) {
                    return false;
                }
                
                unset($patterns['patterns'][$phoneNumber]);
                
                return $this->savePatterns($patterns);
            }
            
            /**
             * Ìå®ÌÑ¥ Í≤ÄÏ¶ù ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
             */
            public function verifyPattern($phoneNumber, $verified = true) {
                $patterns = $this->getPatterns();
                
                if (!isset($patterns['patterns'][$phoneNumber])) {
                    return false;
                }
                
                $pattern = &$patterns['patterns'][$phoneNumber];
                $pattern['needs_verification'] = !$verified;
                
                if ($verified) {
                    $pattern['verified_at'] = date('Y-m-d H:i:s');
                }
                
                return $this->savePatterns($patterns);
            }
            
            /**
             * Ìå®ÌÑ¥ ÌÜµÍ≥Ñ Í∞ÄÏ†∏Ïò§Í∏∞
             */
            public function getPatternStats() {
                $patterns = $this->getPatterns();
                $stats = [
                    'total_patterns' => 0,
                    'auto_generated' => 0,
                    'verified' => 0,
                    'needs_verification' => 0,
                    'most_used' => null,
                    'recent_patterns' => []
                ];
                
                foreach ($patterns['patterns'] as $phone => $pattern) {
                    if ($phone === 'default') continue;
                    
                    $stats['total_patterns']++;
                    
                    if (isset($pattern['auto_generated']) && $pattern['auto_generated']) {
                        $stats['auto_generated']++;
                    }
                    
                    if (isset($pattern['needs_verification']) && $pattern['needs_verification']) {
                        $stats['needs_verification']++;
                    } else {
                        $stats['verified']++;
                    }
                    
                    // Í∞ÄÏû• ÎßéÏù¥ ÏÇ¨Ïö©Îêú Ìå®ÌÑ¥
                    $usageCount = $pattern['usage_count'] ?? 0;
                    if (!$stats['most_used'] || $usageCount > $stats['most_used']['usage_count']) {
                        $stats['most_used'] = array_merge($pattern, ['phone' => $phone]);
                    }
                    
                    // ÏµúÍ∑º ÏÉùÏÑ±Îêú Ìå®ÌÑ¥
                    if (isset($pattern['created_at'])) {
                        $stats['recent_patterns'][] = [
                            'phone' => $phone,
                            'name' => $pattern['name'],
                            'created_at' => $pattern['created_at'],
                            'auto_generated' => $pattern['auto_generated'] ?? false
                        ];
                    }
                }
                
                // ÏµúÍ∑º Ìå®ÌÑ¥ Ï†ïÎ†¨
                usort($stats['recent_patterns'], function($a, $b) {
                    return strtotime($b['created_at']) - strtotime($a['created_at']);
                });
                $stats['recent_patterns'] = array_slice($stats['recent_patterns'], 0, 5);
                
                return $stats;
            }
            
            /**
             * Ìå®ÌÑ¥ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (Î∞±ÏóÖÏö©)
             */
            public function exportPatterns($includeStats = false) {
                $patterns = $this->getPatterns();
                
                if (!$includeStats) {
                    // ÌÜµÍ≥Ñ Ï†ïÎ≥¥ Ï†úÍ±∞
                    foreach ($patterns['patterns'] as &$pattern) {
                        unset($pattern['usage_count'], $pattern['last_used'], 
                              $pattern['success_stats'], $pattern['created_at'], 
                              $pattern['updated_at'], $pattern['verified_at']);
                    }
                }
                
                return $patterns;
            }
            
            /**
             * Ìå®ÌÑ¥ Í∞ÄÏ†∏Ïò§Í∏∞ (Î≥µÏõêÏö©)
             */
            public function importPatterns($importData, $merge = true) {
                if (!is_array($importData) || !isset($importData['patterns'])) {
                    throw new Exception('ÏûòÎ™ªÎêú Ìå®ÌÑ¥ Îç∞Ïù¥ÌÑ∞ ÌòïÏãù');
                }
                
                if ($merge) {
                    $existingPatterns = $this->getPatterns();
                    $importData['patterns'] = array_merge($existingPatterns['patterns'], $importData['patterns']);
                }
                
                return $this->savePatterns($importData);
            }
        }

        // CLI Ïã§ÌñâÏù¥ ÏïÑÎãå Í≤ΩÏö∞ÏóêÎßå Ïõπ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ Ïã§Ìñâ
        if (php_sapi_name() !== 'cli') {
            $manager = new PatternManager();
            $message = '';
            
            // Ìå®ÌÑ¥ Ï∂îÍ∞Ä/ÏàòÏ†ï Ï≤òÎ¶¨
            if ($_SERVER['REQUEST_METHOD'] === 'POST') {
                $action = $_POST['action'] ?? '';
                
                try {
                    if ($action === 'add' || $action === 'edit') {
                        $number = $_POST['number'] ?? '';
                        // Í∏∞Ï°¥ Ìå®ÌÑ¥ Í∞í Î≥¥Ï°¥ÏùÑ ÏúÑÌï¥ Î®ºÏ†Ä Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏòµÎãàÎã§
                        $existingPattern = $manager->getPattern($number);

                        $patternData = array_merge($existingPattern ?? [], [
                            'name' => $_POST['name'] ?? '',
                            'description' => $_POST['description'] ?? '',
                            'initial_wait' => intval($_POST['initial_wait'] ?? 3),
                            'dtmf_timing' => intval($_POST['dtmf_timing'] ?? 6),
                            'dtmf_pattern' => $_POST['dtmf_pattern'] ?? '{ID}#',
                            'confirmation_wait' => intval($_POST['confirmation_wait'] ?? 2),
                            'confirmation_dtmf' => $_POST['confirmation_dtmf'] ?? '1',
                            'total_duration' => intval($_POST['total_duration'] ?? 30),
                            'confirm_delay' => intval($_POST['confirm_delay'] ?? ($existingPattern['confirm_delay'] ?? 2)),
                            'confirm_repeat' => intval($_POST['confirm_repeat'] ?? ($existingPattern['confirm_repeat'] ?? 3)),
                            'notes' => $_POST['notes'] ?? ($existingPattern['notes'] ?? '')
                        ]);
                        
                        $manager->updatePattern($number, $patternData);
                        $message = $action === 'add' ? 
                            '<div class="alert alert-success">‚úÖ Ìå®ÌÑ¥Ïù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!</div>' : 
                            '<div class="alert alert-success">‚úÖ Ìå®ÌÑ¥Ïù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!</div>';
                    }
                    
                    if ($action === 'delete') {
                        $number = $_POST['number'] ?? '';
                        $manager->deletePattern($number);
                        $message = '<div class="alert alert-success">‚úÖ Ìå®ÌÑ¥Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!</div>';
                    }
                } catch (Exception $e) {
                    $message = '<div class="alert alert-error">‚ùå Ïò§Î•ò: ' . htmlspecialchars($e->getMessage()) . '</div>';
                }
            }
            
            // ÌòÑÏû¨ Ìå®ÌÑ¥ Î∞è ÌÜµÍ≥Ñ Î°úÎìú
            $patterns = $manager->getPatterns();
            $stats = $manager->getPatternStats();
            ?>
            
            <?php echo $message; ?>
            
            <!-- ÌÜµÍ≥Ñ Ïπ¥Îìú -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number"><?php echo $stats['total_patterns']; ?></div>
                    <div class="stat-label">Ï†ÑÏ≤¥ Ìå®ÌÑ¥</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number"><?php echo $stats['auto_generated']; ?></div>
                    <div class="stat-label">ÏûêÎèô ÏÉùÏÑ±</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number"><?php echo $stats['verified']; ?></div>
                    <div class="stat-label">Í≤ÄÏ¶ù ÏôÑÎ£å</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number"><?php echo $stats['needs_verification']; ?></div>
                    <div class="stat-label">Í≤ÄÏ¶ù ÌïÑÏöî</div>
                </div>
            </div>
            
            <!-- Ìå®ÌÑ¥ Î™©Î°ù -->
            <div class="card">
                <div class="card-header">
                    üìã Îì±Î°ùÎêú Ìå®ÌÑ¥ Î™©Î°ù
                    <button class="btn btn-small" onclick="checkForNewPatterns()">
                        üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                    </button>
                </div>
                <div class="card-body">
                    <table class="pattern-table" id="patternTable">
                        <thead>
                            <tr>
                                <th>080 Î≤àÌò∏</th>
                                <th>Ïù¥Î¶Ñ</th>
                                <th>ÏÑ§Î™Ö</th>
                                <th>Ï¥àÍ∏∞ÎåÄÍ∏∞</th>
                                <th>DTMFÌÉÄÏù¥Î∞ç</th>
                                <th>DTMFÌå®ÌÑ¥</th>
                                <th>ÌôïÏù∏ÎåÄÍ∏∞</th>
                                <th>ÌôïÏù∏DTMF</th>
                                <th>Ï¥ùÏãúÍ∞Ñ</th>
                                <th>ÏßÄÏó∞</th>
                                <th>Î∞òÎ≥µ</th>
                                <th>ÏÉÅÌÉú</th>
                                <th>Ïï°ÏÖò</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($patterns['patterns'] as $number => $pattern): ?>
                            <tr data-number="<?php echo htmlspecialchars($number); ?>" 
                                data-created="<?php echo $pattern['created_at'] ?? ''; ?>">
                                <td><strong><?php echo htmlspecialchars($number); ?></strong></td>
                                <td>
                                    <?php echo htmlspecialchars($pattern['name']); ?>
                                </td>
                                <td><?php echo htmlspecialchars($pattern['description'] ?? ''); ?></td>
                                <td><?php echo $pattern['initial_wait']; ?>Ï¥à</td>
                                <td><?php echo $pattern['dtmf_timing']; ?>Ï¥à</td>
                                <td><code><?php echo htmlspecialchars($pattern['dtmf_pattern']); ?></code></td>
                                <td><?php echo $pattern['confirmation_wait']; ?>Ï¥à</td>
                                <td><?php echo htmlspecialchars($pattern['confirmation_dtmf']); ?></td>
                                <td><?php echo $pattern['total_duration']; ?>Ï¥à</td>
                                <td><?php echo $pattern['confirm_delay'] ?? 2; ?>Ï¥à</td>
                                <td><?php echo $pattern['confirm_repeat'] ?? 3; ?>Ìöå</td>
                                <td>
                                    <?php if (isset($pattern['needs_verification']) && $pattern['needs_verification']): ?>
                                        <span class="label needs-verification">Í≤ÄÏ¶ù ÌïÑÏöî</span>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-small btn-secondary" onclick="editPattern('<?php echo $number; ?>')">ÏàòÏ†ï</button>
                                        <?php if ($number !== 'default'): ?>
                                        <form method="post" style="display:inline;">
                                            <input type="hidden" name="action" value="delete">
                                            <input type="hidden" name="number" value="<?php echo $number; ?>">
                                            <button type="submit" class="btn btn-small btn-danger" 
                                                    onclick="return confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')">ÏÇ≠Ï†ú</button>
                                        </form>
                                        <?php endif; ?>
                                    </div>
                                </td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Ìå®ÌÑ¥ Ï∂îÍ∞Ä/ÏàòÏ†ï Ìèº -->
            <div class="card">
                <div class="card-header" id="form-header">
                    ‚ûï ÏÉà Ìå®ÌÑ¥ Ï∂îÍ∞Ä
                </div>
                <div class="card-body">
                    <form method="post" id="pattern-form">
                        <input type="hidden" name="action" value="add" id="form-action">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="form-number">080 Î≤àÌò∏</label>
                                <input type="text" name="number" id="form-number" placeholder="0801234567" required>
                                <div class="help-text">ÌïòÏù¥Ìîà(-) ÏóÜÏù¥ Ïà´ÏûêÎßå ÏûÖÎ†•</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="form-name">Ìå®ÌÑ¥ Ïù¥Î¶Ñ</label>
                                <input type="text" name="name" id="form-name" placeholder="ÌöåÏÇ¨Î™Ö Ìå®ÌÑ¥" required>
                                <div class="help-text">ÏãùÎ≥ÑÌïòÍ∏∞ Ïâ¨Ïö¥ Ïù¥Î¶Ñ</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="form-description">ÏÑ§Î™Ö</label>
                            <input type="text" name="description" id="form-description" placeholder="Ìå®ÌÑ¥Ïóê ÎåÄÌïú ÏÑ§Î™Ö">
                        </div>
                        
                        <h3 style="margin: 30px 0 20px; color: #4a5568;">‚è±Ô∏è ÌÉÄÏù¥Î∞ç ÏÑ§Ï†ï (Ï¥à)</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="form-initial-wait">Ï¥àÍ∏∞ ÎåÄÍ∏∞</label>
                                <input type="number" name="initial_wait" id="form-initial-wait" value="3" min="0" max="10">
                                <div class="help-text">ÌÜµÌôî Ïó∞Í≤∞ ÌõÑ ÎåÄÍ∏∞ ÏãúÍ∞Ñ</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="form-dtmf-timing">DTMF ÌÉÄÏù¥Î∞ç</label>
                                <input type="number" name="dtmf_timing" id="form-dtmf-timing" value="6" min="0" max="20">
                                <div class="help-text">Ï≤´ DTMF ÏûÖÎ†• ÏãúÏ†ê</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="form-confirmation-wait">ÌôïÏù∏ ÎåÄÍ∏∞</label>
                                <input type="number" name="confirmation_wait" id="form-confirmation-wait" value="2" min="0" max="15">
                                <div class="help-text">ÌôïÏù∏ Î≤ÑÌäº ÏûÖÎ†• Ï†Ñ ÎåÄÍ∏∞</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="form-total-duration">Ï¥ù ÎÖπÏùåÏãúÍ∞Ñ</label>
                                <input type="number" name="total_duration" id="form-total-duration" value="30" min="10" max="60">
                                <div class="help-text">Ï†ÑÏ≤¥ ÌÜµÌôî ÎÖπÏùå ÏãúÍ∞Ñ</div>
                            </div>
                            <div class="form-group">
                                <label for="form-confirm-delay">ÌôïÏù∏ ÏßÄÏó∞</label>
                                <input type="number" name="confirm_delay" id="form-confirm-delay" value="2" min="0" max="10">
                                <div class="help-text">Î∞òÎ≥µ ÌôïÏù∏ DTMF Í∞ÑÍ≤©(Ï¥à)</div>
                            </div>
                            <div class="form-group">
                                <label for="form-confirm-repeat">Î∞òÎ≥µ ÌöüÏàò</label>
                                <input type="number" name="confirm_repeat" id="form-confirm-repeat" value="3" min="1" max="5">
                                <div class="help-text">ÌôïÏù∏ DTMF Ï†ÑÏÜ° ÌöüÏàò</div>
                            </div>
                        </div>
                        
                        <h3 style="margin: 30px 0 20px; color: #4a5568;">üìû DTMF ÏÑ§Ï†ï</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="form-dtmf-pattern">DTMF Ìå®ÌÑ¥</label>
                                <input type="text" name="dtmf_pattern" id="form-dtmf-pattern" value="{ID}#" placeholder="{ID}# ÎòêÎäî 1,2,3">
                                <div class="help-text">{ID}Îäî ÏãùÎ≥ÑÎ≤àÌò∏Î°ú ÏπòÌôòÎê©ÎãàÎã§</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="form-confirmation-dtmf">ÌôïÏù∏ DTMF</label>
                                <input type="text" name="confirmation_dtmf" id="form-confirmation-dtmf" value="1" placeholder="1">
                                <div class="help-text">ÌôïÏù∏ÏùÑ ÏúÑÌï¥ ÎàÑÎ•º Î≤àÌò∏</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="form-notes">Î©îÎ™®</label>
                            <textarea name="notes" id="form-notes" rows="3" placeholder="Ï∂îÍ∞Ä Î©îÎ™®ÎÇò ÌäπÏù¥ÏÇ¨Ìï≠"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 30px;">
                            <button type="submit" class="btn" id="submit-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                                </svg>
                                Ìå®ÌÑ¥ Ï∂îÍ∞Ä
                            </button>
                            <button type="button" class="btn btn-secondary" id="cancel-btn" onclick="cancelEdit()" style="display:none;">
                                Ï∑®ÏÜå
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- ÏÇ¨Ïö© ÌåÅ -->
            <div class="card">
                <div class="card-header">
                    üí° ÏÇ¨Ïö© ÌåÅ
                </div>
                <div class="card-body">
                    <ul style="line-height: 1.8; color: #4a5568;">
                        <li><strong>{ID}</strong>: Í¥ëÍ≥† Î¨∏ÏûêÏóêÏÑú Ï∂îÏ∂úÌïú ÏãùÎ≥ÑÎ≤àÌò∏Î°ú ÏûêÎèô ÏπòÌôòÎê©ÎãàÎã§</li>
                        <li><strong>{Phone}</strong>: ÏÇ¨Ïö©Ïûê Ï†ÑÌôîÎ≤àÌò∏Î°ú ÏπòÌôòÎê©ÎãàÎã§ (ÌïÑÏöîÌïú Í≤ΩÏö∞)</li>
                        <li><strong>DTMF ÌÉÄÏù¥Î∞ç</strong>: ÌÜµÌôî ÏãúÏûë ÌõÑ Ï≤´ Î≤àÏß∏ DTMFÎ•º Î≥¥ÎÇº ÏãúÏ†ê (Ï¥à)</li>
                        <li><strong>ÌôïÏù∏ DTMF</strong>: ÏãùÎ≥ÑÎ≤àÌò∏ ÏûÖÎ†• ÌõÑ ÌôïÏù∏ÏùÑ ÏúÑÌï¥ ÎàÑÎ•º Î≤àÌò∏ (Î≥¥ÌÜµ 1)</li>
                        <li>ÏÉàÎ°úÏö¥ 080 Î≤àÌò∏Îäî Î®ºÏ†Ä <strong>default</strong> Ìå®ÌÑ¥ÏúºÎ°ú ÌÖåÏä§Ìä∏ ÌõÑ Ï°∞Ï†ïÌïòÏÑ∏Ïöî</li>
                        <li>Ìå®ÌÑ¥ Î∂ÑÏÑùÏù¥ ÏôÑÎ£åÎêòÎ©¥ ÏûêÎèôÏúºÎ°ú Ïù¥ Î™©Î°ùÏóê Ï∂îÍ∞ÄÎê©ÎãàÎã§</li>
                    </ul>
                </div>
            </div>
        </div>

        <script>
            // Ìå®ÌÑ¥ Îç∞Ïù¥ÌÑ∞Î•º JavaScriptÏóêÏÑú ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎèÑÎ°ù Î≥ÄÌôò
            const patterns = <?php echo json_encode($patterns['patterns']); ?>;
            let lastCheckTime = new Date().toISOString();
            
            function editPattern(number) {
                const pattern = patterns[number];
                if (!pattern) return;
                
                // Ìèº Ï†úÎ™©Í≥º Ïï°ÏÖò Î≥ÄÍ≤Ω
                document.getElementById('form-header').textContent = '‚úèÔ∏è Ìå®ÌÑ¥ ÏàòÏ†ï';
                document.getElementById('form-action').value = 'edit';
                document.getElementById('submit-btn').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/></svg> Ìå®ÌÑ¥ ÏàòÏ†ï';
                document.getElementById('cancel-btn').style.display = 'inline-flex';
                
                // Ìèº ÌïÑÎìú Ï±ÑÏö∞Í∏∞
                document.getElementById('form-number').value = number;
                document.getElementById('form-name').value = pattern.name || '';
                document.getElementById('form-description').value = pattern.description || '';
                document.getElementById('form-initial-wait').value = pattern.initial_wait || 3;
                document.getElementById('form-dtmf-timing').value = pattern.dtmf_timing || 6;
                document.getElementById('form-confirmation-wait').value = pattern.confirmation_wait || 2;
                document.getElementById('form-total-duration').value = pattern.total_duration || 30;
                document.getElementById('form-confirm-delay').value = pattern.confirm_delay || 2;
                document.getElementById('form-confirm-repeat').value = pattern.confirm_repeat || 3;
                document.getElementById('form-dtmf-pattern').value = pattern.dtmf_pattern || '{ID}#';
                document.getElementById('form-confirmation-dtmf').value = pattern.confirmation_dtmf || '1';
                document.getElementById('form-notes').value = pattern.notes || '';
                
                // Î≤àÌò∏ ÌïÑÎìúÎ•º ÏùΩÍ∏∞ Ï†ÑÏö©ÏúºÎ°ú ÏÑ§Ï†ï
                document.getElementById('form-number').readOnly = true;
                
                // ÌèºÏúºÎ°ú Ïä§ÌÅ¨Î°§
                document.getElementById('pattern-form').scrollIntoView({ behavior: 'smooth' });
            }
            
            function cancelEdit() {
                // Ìèº Ï¥àÍ∏∞Ìôî
                document.getElementById('form-header').textContent = '‚ûï ÏÉà Ìå®ÌÑ¥ Ï∂îÍ∞Ä';
                document.getElementById('form-action').value = 'add';
                document.getElementById('submit-btn').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/></svg> Ìå®ÌÑ¥ Ï∂îÍ∞Ä';
                document.getElementById('cancel-btn').style.display = 'none';
                
                // ÌïÑÎìú Ï¥àÍ∏∞Ìôî
                document.getElementById('pattern-form').reset();
                document.getElementById('form-number').readOnly = false;
                
                // Í∏∞Î≥∏Í∞í Î≥µÏõê
                document.getElementById('form-initial-wait').value = 3;
                document.getElementById('form-dtmf-timing').value = 6;
                document.getElementById('form-confirmation-wait').value = 2;
                document.getElementById('form-total-duration').value = 30;
                document.getElementById('form-confirm-delay').value = 2;
                document.getElementById('form-confirm-repeat').value = 3;
                document.getElementById('form-dtmf-pattern').value = '{ID}#';
                document.getElementById('form-confirmation-dtmf').value = '1';
            }
            
            // ÏÉàÎ°úÏö¥ Ìå®ÌÑ¥ ÌôïÏù∏ (Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏)
            function checkForNewPatterns() {
                fetch('patterns.json?t=' + Date.now())
                    .then(response => response.json())
                    .then(data => {
                        const currentPatterns = data.patterns;
                        const tbody = document.querySelector('#patternTable tbody');
                        
                        // ÏÉàÎ°úÏö¥ Ìå®ÌÑ¥ ÌôïÏù∏
                        Object.keys(currentPatterns).forEach(number => {
                            const existingRow = tbody.querySelector(`tr[data-number="${number}"]`);
                            const pattern = currentPatterns[number];
                            
                            if (!existingRow && pattern.created_at > lastCheckTime) {
                                // ÏÉà Ìå®ÌÑ¥ Ï∂îÍ∞Ä
                                const newRow = createPatternRow(number, pattern);
                                tbody.insertBefore(newRow, tbody.firstChild);
                                newRow.classList.add('new-pattern');
                                
                                // ÏïåÎ¶º ÌëúÏãú
                                showNotification(`ÏÉà Ìå®ÌÑ¥Ïù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§: ${number}`);
                            }
                        });
                        
                        lastCheckTime = new Date().toISOString();
                    })
                    .catch(error => console.error('Ìå®ÌÑ¥ ÌôïÏù∏ Ïò§Î•ò:', error));
            }
            
            // Ìå®ÌÑ¥ Ìñâ ÏÉùÏÑ±
            function createPatternRow(number, pattern) {
                const tr = document.createElement('tr');
                tr.setAttribute('data-number', number);
                tr.setAttribute('data-created', pattern.created_at || '');
                
                const autoGenBadge = pattern.auto_generated ? '<span class="badge badge-auto">ÏûêÎèô</span>' : '';
                const verifiedBadge = pattern.needs_verification ? 
                    '<span class="badge badge-unverified">ÎØ∏Í≤ÄÏ¶ù</span>' : 
                    '<span class="badge badge-verified">Í≤ÄÏ¶ùÎê®</span>';
                const typeBadge = (pattern.pattern_type === 'confirm_only') ? '<span class="badge badge-unverified">Confirm-Only</span>' :
                                  (pattern.pattern_type === 'id_only') ? '<span class="badge badge-verified">ID-Only</span>' : '';
                const supportedBadge = (pattern.auto_supported === false) ? '<span class="badge badge-unverified">ÏàòÎèô</span>' : '';
                
                tr.innerHTML = `
                    <td><strong>${number}</strong></td>
                    <td>
                        ${pattern.name} ${autoGenBadge} ${typeBadge} ${supportedBadge}
                    </td>
                `;
                
                return tr;
            }
            
            // ÏïåÎ¶º ÌëúÏãú
            function showNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'alert alert-success';
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.right = '20px';
                notification.style.zIndex = '1000';
                notification.textContent = 'üéâ ' + message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
            
            // 10Ï¥àÎßàÎã§ ÏÉà Ìå®ÌÑ¥ ÌôïÏù∏
            setInterval(checkForNewPatterns, 10000);

            // Ìå®ÌÑ¥ ÏÇ≠Ï†ú Ï≤òÎ¶¨
            function deletePattern(number) {
                if (!confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    return;
                }
                
                // AJAXÎ°ú ÏÇ≠Ï†ú ÏöîÏ≤≠
                fetch('delete_pattern.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'number=' + encodeURIComponent(number)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                        showMessage(data.message, 'success');
                        
                        // Ìï¥Îãπ Ìñâ Ï†úÍ±∞
                        const row = document.querySelector(`tr[data-number="${number}"]`);
                        if (row) {
                            row.remove();
                        }
                    } else {
                        // Ïò§Î•ò Î©îÏãúÏßÄ ÌëúÏãú
                        showMessage(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('Ìå®ÌÑ¥ ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                });
            }

            // Î©îÏãúÏßÄ ÌëúÏãú Ìï®Ïàò
            function showMessage(message, type = 'info') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `alert alert-${type}`;
                messageDiv.textContent = message;
                
                const container = document.querySelector('.container');
                container.insertBefore(messageDiv, container.firstChild);
                
                // 3Ï¥à ÌõÑ Î©îÏãúÏßÄ Ï†úÍ±∞
                setTimeout(() => {
                    messageDiv.remove();
                }, 3000);
            }

            // Ìå®ÌÑ¥ Î∂ÑÏÑù ÏßÑÌñâ ÏÉÅÌÉú ÌôïÏù∏
            function checkPatternAnalysisProgress() {
                fetch('get_pattern_analysis_progress.php')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // ÏßÑÌñâ ÏÉÅÌÉú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                            updateProgressDisplay(data);
                            
                            // Î∂ÑÏÑùÏù¥ ÏôÑÎ£åÎêòÏßÄ ÏïäÏïòÍ≥† Î¶¨ÌîÑÎ†àÏãú Î∞©ÏßÄÍ∞Ä ÌïÑÏöîÌïú Í≤ΩÏö∞
                            if (!data.completed && data.prevent_refresh) {
                                // 1Ï¥à ÌõÑ Îã§Ïãú ÌôïÏù∏
                                setTimeout(checkPatternAnalysisProgress, 1000);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error checking progress:', error);
                    });
            }

            // ÏßÑÌñâ ÏÉÅÌÉú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
            function updateProgressDisplay(data) {
                const progressBar = document.getElementById('analysis-progress');
                const progressMessage = document.getElementById('analysis-message');
                
                if (progressBar && progressMessage) {
                    progressBar.style.width = data.percentage + '%';
                    progressMessage.textContent = data.message;
                    
                    if (data.completed) {
                        progressBar.classList.add('completed');
                    }
                }
            }

            // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏßÑÌñâ ÏÉÅÌÉú ÌôïÏù∏ ÏãúÏûë
            document.addEventListener('DOMContentLoaded', function() {
                checkPatternAnalysisProgress();
            });
        </script>
    </div>
</body>
</html>
<?php
        } // CLI Ï≤¥ÌÅ¨ Îã´Îäî Í¥ÑÌò∏
?>