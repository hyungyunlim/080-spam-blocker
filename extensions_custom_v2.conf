; ==========================================================
;  1. Quectel 모뎀으로 전화/문자 수신 시 처리
; ==========================================================
[incoming-mobile]

exten => sms,1,Verbose(Incoming SMS from ${CALLERID(num)} ${BASE64_DECODE(${SMS_BASE64})})
exten => sms,n,Set(FILE(/var/log/asterisk/sms.txt,,,a)=SMS From ${CALLERID(num)} on ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
exten => sms,n,System(echo "" >> /var/log/asterisk/sms.txt)
exten => sms,n,Set(FILE(/var/log/asterisk/sms.txt,,,a)=${BASE64_DECODE(${SMS_BASE64})})
exten => sms,n,System(echo "" >> /var/log/asterisk/sms.txt)
exten => sms,n,Hangup()

exten => _.,1,Set(CALLERID(name)=${CALLERID(num)})
exten => _.,n,Goto(from-trunk,${EXTEN},1)


; ==========================================================
;  2. Call File을 통해 발신 전화 처리 (동적 패턴 버전)
; ==========================================================

[callfile-handler]
; Call File이 quectel 채널로 전화를 걸고, 상대방이 받으면 이 컨텍스트를 실행합니다.
exten => s,1,NoOp(== Call answered. Executing actions for CallFile ID: ${CALLFILE_ID} ==)
exten => s,n,Answer()
exten => s,n,Wait(1)

; 1. AstDB에서 변수 값 가져오기
exten => s,n,Set(DTMF_TO_SEND=${DB(CallFile/${CALLFILE_ID}/dtmf)})
exten => s,n,Set(DIALED_NUMBER_FOR_REC=${DB(CallFile/${CALLFILE_ID}/recnum)})

; 2. Call File에서 전달된 타이밍 변수 사용 (없으면 기본값)
exten => s,n,Set(INITIAL_WAIT=${IF($[${EXISTS(${INITIAL_WAIT})}]?${INITIAL_WAIT}:3)})
exten => s,n,Set(DTMF_TIMING=${IF($[${EXISTS(${DTMF_TIMING})}]?${DTMF_TIMING}:6)})
exten => s,n,Set(CONFIRM_WAIT=${IF($[${EXISTS(${CONFIRM_WAIT})}]?${CONFIRM_WAIT}:5)})
exten => s,n,Set(TOTAL_DURATION=${IF($[${EXISTS(${TOTAL_DURATION})}]?${TOTAL_DURATION}:30)})
exten => s,n,Set(CONFIRM_DELAY=${IF($[${EXISTS(${CONFIRM_DELAY})}]?${CONFIRM_DELAY}:1)})
exten => s,n,Set(CONFIRM_REPEAT=${IF($[${EXISTS(${CONFIRM_REPEAT})}]?${CONFIRM_REPEAT}:1)})

; 3. AstDB에서 사용한 데이터 삭제 (정리)
exten => s,n,NoOp(${DB_DELETE(CallFile/${CALLFILE_ID}/dtmf)})
exten => s,n,NoOp(${DB_DELETE(CallFile/${CALLFILE_ID}/recnum)})
exten => s,n,NoOp(${DB_DELETE(CallFile/${CALLFILE_ID}/pattern)})

; 4. 로그 남기기
exten => s,n,NoOp(Retrieved from DB -> DTMF: ${DTMF_TO_SEND}, Number: ${DIALED_NUMBER_FOR_REC})
exten => s,n,NoOp(Timing -> Initial: ${INITIAL_WAIT}s, DTMF: ${DTMF_TIMING}s, Confirm: ${CONFIRM_WAIT}s, Total: ${TOTAL_DURATION}s)

; 5. DTMF 분리 (예: 105623#1 -> 105623# 와 1)
exten => s,n,Set(DTMF_LEN=${LEN(${DTMF_TO_SEND})})
exten => s,n,Set(DTMF_FIRST=${DTMF_TO_SEND:0:$[${DTMF_LEN}-1]})
exten => s,n,Set(DTMF_SECOND=${DTMF_TO_SEND:$[${DTMF_LEN}-1]:1})
exten => s,n,NoOp(Split DTMF -> First: ${DTMF_FIRST}, Second: ${DTMF_SECOND})

; 6. 녹음 파일 이름 설정 및 녹음 시작
exten => s,n,Set(TIMESTAMP=${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)})
exten => s,n,Set(MONITOR_FILENAME=/var/spool/asterisk/monitor/${TIMESTAMP}-FROM_SYSTEM-TO_${DIALED_NUMBER_FOR_REC})
exten => s,n,NoOp(Starting recording: ${MONITOR_FILENAME}.wav)
exten => s,n,MixMonitor(${MONITOR_FILENAME}.wav,W(2))
exten => s,n,Wait(2)
exten => s,n,NoOp(Recording should be active now)

; 7. 초기 시스템 안내 대기 (동적)
exten => s,n,NoOp(Waiting for initial system greeting - ${INITIAL_WAIT} seconds...)
exten => s,n,Wait(${INITIAL_WAIT})

; 8. 1단계 DTMF 전송 (동적 타이밍)
exten => s,n,NoOp(Total wait before DTMF: $[1+2+${INITIAL_WAIT}] = $[3+${INITIAL_WAIT}] seconds)
exten => s,n,NoOp(Sending FIRST DTMF at ${DTMF_TIMING} second mark: ${DTMF_FIRST})
exten => s,n,Set(ADDITIONAL_WAIT=$[${DTMF_TIMING}-3-${INITIAL_WAIT}])
exten => s,n,GotoIf($[${ADDITIONAL_WAIT} > 0]?wait_more:send_dtmf)
exten => s,n(wait_more),Wait(${ADDITIONAL_WAIT})
exten => s,n(send_dtmf),SendDTMF(wwwwwwwwww${DTMF_FIRST})
exten => s,n,Wait(1)

; 9. 시스템 확인 요청 대기 (동적)
exten => s,n,NoOp(Waiting for system confirmation request - ${CONFIRM_WAIT} seconds...)
exten => s,n,Wait(${CONFIRM_WAIT})

; 10. 2단계 DTMF 전송 (확인을 위한 "1")
exten => s,n,NoOp(Sending SECOND DTMF for confirmation ${CONFIRM_REPEAT} times every ${CONFIRM_DELAY}s: ${DTMF_SECOND})
exten => s,n,Set(LOOP_CNT=0)
exten => s,n(loop_confirm_send),SendDTMF(${DTMF_SECOND})
exten => s,n,Set(LOOP_CNT=$[${LOOP_CNT}+1])
exten => s,n,GotoIf($[${LOOP_CNT} >= ${CONFIRM_REPEAT}]?loop_confirm_end)
exten => s,n,Wait(${CONFIRM_DELAY})
exten => s,n,Goto(loop_confirm_send)
exten => s,n(loop_confirm_end),NoOp(Completed ${CONFIRM_REPEAT} confirmation DTMF sends)
exten => s,n,Wait(1)

; 11. 최종 처리 및 결과 안내 대기 (동적 계산)
exten => s,n,Set(ELAPSED=$[3+${INITIAL_WAIT}+${ADDITIONAL_WAIT}+1+${CONFIRM_WAIT}+1])
exten => s,n,Set(REMAINING=$[${TOTAL_DURATION}-${ELAPSED}])
exten => s,n,NoOp(Elapsed: ${ELAPSED}s, Remaining: ${REMAINING}s of total ${TOTAL_DURATION}s)
exten => s,n,GotoIf($[${REMAINING} > 0]?final_wait:end_call)
exten => s,n(final_wait),Wait(${REMAINING})
exten => s,n(end_call),NoOp(Recording completed - total ${TOTAL_DURATION} seconds from answer)
exten => s,n,Hangup() 