; ==========================================================
;  1. Quectel 모뎀으로 전화/문자 수신 시 처리
; ==========================================================
[incoming-mobile]

exten => sms,1,Verbose(Incoming SMS from ${CALLERID(num)} ${BASE64_DECODE(${SMS_BASE64})})
exten => sms,n,Set(FILE(/var/log/asterisk/sms.txt,,,a)=SMS From ${CALLERID(num)} on ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
exten => sms,n,System(echo "" >> /var/log/asterisk/sms.txt)
exten => sms,n,Set(FILE(/var/log/asterisk/sms.txt,,,a)=${BASE64_DECODE(${SMS_BASE64})})
exten => sms,n,System(echo "" >> /var/log/asterisk/sms.txt)
exten => sms,n,Hangup()

exten => _.,1,Set(CALLERID(name)=${CALLERID(num)})
exten => _.,n,Goto(from-trunk,${EXTEN},1)


; ==========================================================
;  2. Call File을 통해 발신 전화 처리 (2단계 DTMF 버전)
; ==========================================================

[callfile-handler]
; Call File이 quectel 채널로 전화를 걸고, 상대방이 받으면 이 컨텍스트를 실행합니다.
exten => s,1,NoOp(== Call answered. Executing actions for CallFile ID: ${CALLFILE_ID} ==)
exten => s,n,Answer()
exten => s,n,Wait(1)

; 1. AstDB에서 변수 값 가져오기
exten => s,n,Set(DTMF_TO_SEND=${DB(CallFile/${CALLFILE_ID}/dtmf)})
exten => s,n,Set(DIALED_NUMBER_FOR_REC=${DB(CallFile/${CALLFILE_ID}/recnum)})

; 2. AstDB에서 사용한 데이터 삭제 (정리)
exten => s,n,NoOp(${DB_DELETE(CallFile/${CALLFILE_ID}/dtmf)})
exten => s,n,NoOp(${DB_DELETE(CallFile/${CALLFILE_ID}/recnum)})

; 3. 로그 남기기
exten => s,n,NoOp(Retrieved from DB -> DTMF: ${DTMF_TO_SEND}, Number for Rec: ${DIALED_NUMBER_FOR_REC})

; 4. DTMF 분리 (예: 105623#1 -> 105623# 와 1)
exten => s,n,Set(DTMF_LEN=${LEN(${DTMF_TO_SEND})})
exten => s,n,Set(DTMF_FIRST=${DTMF_TO_SEND:0:$[${DTMF_LEN}-1]})
exten => s,n,Set(DTMF_SECOND=${DTMF_TO_SEND:$[${DTMF_LEN}-1]:1})
exten => s,n,NoOp(Split DTMF -> First: ${DTMF_FIRST}, Second: ${DTMF_SECOND})

; 5. 녹음 파일 이름 설정 및 녹음 시작
exten => s,n,Set(TIMESTAMP=${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)})
exten => s,n,Set(MONITOR_FILENAME=/var/spool/asterisk/monitor/${TIMESTAMP}-FROM_SYSTEM-TO_${DIALED_NUMBER_FOR_REC})
exten => s,n,NoOp(Starting recording: ${MONITOR_FILENAME}.wav)
exten => s,n,MixMonitor(${MONITOR_FILENAME}.wav,W(2))
exten => s,n,Wait(2)
exten => s,n,NoOp(Recording should be active now)

; 6. 초기 시스템 안내 대기 (Answer(1초) + 녹음안정화(2초) + 이 대기(3초) = 총 6초)
exten => s,n,NoOp(Waiting for initial system greeting - timing for 6-7 seconds...)
exten => s,n,Wait(3)

; 7. 1단계 DTMF 전송 (105623# 등, 마지막 1 제외)
exten => s,n,NoOp(Sending FIRST DTMF at 6-7 second mark: ${DTMF_FIRST})
exten => s,n,SendDTMF(wwwwwwwwww${DTMF_FIRST})
exten => s,n,Wait(1)

; 8. 시스템 확인 요청 대기 ("105623번이 맞으면 1번을 눌러주세요")
exten => s,n,NoOp(Waiting for system confirmation request...)
exten => s,n,Wait(5)

; 9. 2단계 DTMF 전송 (확인을 위한 "1")
exten => s,n,NoOp(Sending SECOND DTMF for confirmation: ${DTMF_SECOND})
exten => s,n,SendDTMF(${DTMF_SECOND})
exten => s,n,Wait(1)

; 10. 최종 처리 및 결과 안내 대기
exten => s,n,NoOp(Waiting for final processing and confirmation message...)
exten => s,n,Wait(12)

; 11. 녹음 완료 및 통화 종료 (총 약 30초 녹음)
exten => s,n,NoOp(Recording completed - total ~30 seconds from answer)
exten => s,n,Hangup() 